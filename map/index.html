<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta charset="utf-8">
    <meta content="always" name="referrer">
    
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>汉服组织查询系统 - 汉服百科</title>
    <style type="text/css">
        html,
        body {
            width: 100%;
            height: 100%;
        }

        
        body,
        button,
        input,
        select,
        textarea {
            font: 12px/16px Verdana, Helvetica, Arial, sans-serif;
        }

        #container {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #mapContainer {
            position: relative;
            height: 100%;
            width: 100%;
        }

        .clusterBubble {
            border-radius: 50%;
            color: #fff;
            font-weight: 500;
            text-align: center;
            opacity: 0.88;
            background-image: linear-gradient(139deg, #e82f40 0%, #fb0e4f 100%);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.20);
            position: absolute;
            top: 0px;
            left: 0px;
        }

        /* 组织信息页面 */
        @font-face {
            font-family: "iconfont";
            src: url('//at.alicdn.com/t/font_1692848_ofchcawy11.eot?t=1597031491457');
            /* IE9 */
            src: url('//at.alicdn.com/t/font_1692848_ofchcawy11.eot?t=1597031491457#iefix') format('embedded-opentype'),
                /* IE6-IE8 */
                url('data:application/x-font-woff2;charset=utf-8;base64,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') format('woff2'),
                url('//at.alicdn.com/t/font_1692848_ofchcawy11.woff?t=1597031491457') format('woff'),
                url('//at.alicdn.com/t/font_1692848_ofchcawy11.ttf?t=1597031491457') format('truetype'),
                /* chrome, firefox, opera, Safari, Android, iOS 4.2+ */
                url('//at.alicdn.com/t/font_1692848_ofchcawy11.svg?t=1597031491457#iconfont') format('svg');
            /* iOS 4.1- */
        }

        .iconfont {
            font-family: "iconfont" !important;
            font-size: 16px;
            font-style: normal;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .iconlianxiren:before {
            content: "\e654";
        }

        .icondianhua:before {
            content: "\e614";
        }

        .iconshouji:before {
            content: "\e70a";
        }

        .iconleixing:before {
            content: "\e605";
        }

        .iconqq:before {
            content: "\e601";
        }

        .iconfanhui:before {
            content: "\e602";
        }

        .icondizhi:before {
            content: "\e603";
        }

        .iconweixin:before {
            content: "\e604";
        }


        .orgpage {
            background: #f6f6f6;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            word-break: break-all;
            width: auto;
            text-align: left;
            white-space: initial;
            line-height: 1.2;
        }

        swiper {
            height: 215px;
            width: 100vw;
            background: #eee;
        }

        swiper .slide {
            width: 100%;
            height: 100%;
        }

        .head-wrapper {
            position: relative;
            background: #fff;
        }

        .head-wrapper.logo-mode .title {
            padding: 5px 10px 10px 90px;
        }

        .head-wrapper .logo {
            position: absolute;
            top: -30px;
            left: 5px;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            overflow: hidden;
            background: #eee;
            border: 4px solid #fff;
        }

        .head-wrapper .title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 10px 10px 20px;
            border-bottom: 1px solid #eee;
        }

        .head-wrapper .title .name {
            font-size: 21px;
        }

        .head-wrapper .navigate {
            width: 50px;
            height: 50px;
            padding: 10px;
            box-sizing: border-box;
        }

        .more {
            background: #fff;
            padding: 10px;
            margin-bottom: 5px;
            box-shadow: 0 0 10px #eee;
            font-size: 12px;
        }

        .more i {
            padding-right: 2px;
            color: #37aafc;
        }

        .item {
            font-size: 14px;
            padding-bottom: 2px;
        }

        .desc {
            min-height: 172.5px;
            background: #fff;
            padding: 10px;
            box-shadow: 0 0 10px #eee;
            margin-bottom: 10px;
            white-space: initial;
        }

        .desc .title {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .desc .title::before {
            content: "|";
            padding-right: 4px;
            color: #37aafc;
        }

        .desc .content {
            font-size: 14px;
        }

        .video-wrapper {
            margin: 15px 0;
        }

        .video-wrapper video {
            width: 100%;
        }

        .video-wrapper .copyright {
            font-size: 10px;
            padding-top: 5px;
            color: #aaa;
        }

        .video-wrapper .copyright .name {
            color: #37aafc;
        }

        .adContainer {
            width: 90%;
            margin: 0 auto;
            margin-bottom: 10px;
        }

        .layout {
            width: 1000px;
            margin: 30px auto;
        }

        ul,
        ol,
        li {
            list-style: none;
        }

        .slide {
            position: relative;
            width: 100%;
            height: 260px;
            margin: auto;
        }

        .slide .outer {
            position: relative;
            overflow: hidden;
            height: 260px;
        }

        .slide .outer .inner {
            width: 2800px;
            height: 100%;
            position: absolute;
            left: 0px;
            top: 0;
            padding-left: 0px;
            margin-block-start: 0px;
        }

        .slide .outer .inner li {
            float: left;
            height: 100%;
        }

        .slide .outer .inner li a {
            display: block;
            position: relative;
            width: 400px;
            height: 100%;
        }

        .slide .outer .inner li a p {
            position: absolute;
            left: 0;
            bottom: 0;
            color: #fff;
            font-size: 18px;
            width: auto;
            height: 80px;
            line-height: 80px;
            padding-left: 50px;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.5));
        }
        .slide .outer .inner li a img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .slide .outer .dot {
            margin-top: 52%;
            text-align: center;
            position: relative;
        }

        .slide .outer .dot li {
            height: 6px;
            width: 6px;
            border-radius: 3px;
            background-color: #d2cbcb;
            display: inline-block;
            margin: 0 3px;
        }

        .slide .outer .dot li.active {
            background-color: #6e5ca5;
        }

        .slide .arrow-box {
            position: absolute;
            /*width: 100%;*/
            height: 60px;
            top: 40%;
            left: 0;
        }

        .slide .arrow-box .arrow {
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            border-radius: 30px;
            background-color: #dde2e6;
            font-size: 30px;
            color: #999;
            cursor: pointer;
        }

        .slide .arrow-box .arrow.arrow-l {
            float: left;
        }

        .slide .arrow-box .arrow.arrow-r {
            float: right;
            right: 10px;
            position: fixed;
        }

        #searchPart {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1001;
            width: 19rem;
            box-shadow: 0 2px 2px rgba(0,0,0,.15);
        }

        .weui-search-bar__box {
            padding-left: 58px !important;
        }
        .weui-search-bar__box .weui-icon-search {
            left: 32px !important;
        }
        .weui-search-bar__form .logo {
            display: block;
            position: absolute;
            width: 34px;
            height: 34px;
            z-index: 99999;
            cursor: pointer;

        }
        .weui-search-bar__box .weui-search-bar__input{
            font-size: 15px !important;
        }
        .weui-search-bar__label span{
            font-size: 15px !important;
        }
        .weui-search-bar__cancel-btn{
            font-size: 15px !important;
        }
        .tips{
            font-size: 15px !important;
        }

        .common_content_box {
            position: absolute;
            right: 0;
            left: 0;
            z-index: 1;
            width: 100%;
        }
        .back {
            position: absolute;
            top: 8px;
            left: 15px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(0,0,0,.4)url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAArCAQAAADIkIBwAAABG0lEQVR4Ac3V1UEDURSE4cHd3d2tJ4qAArYTSsBdX5Js3FMCDSBBhoM791x85e37V54G5oM19PIA2oO1DJD0Iw+5yNHylL8TJShGgSQGHhSe3OlGNerkLkaejtegBa2SlHwQsO6RC+6QpBpFyDXwra4b3il37c3zc97jIeGJH+L1D7zWgm90annYml+qecNv8LUOLY/Y8ajwuJJL4FpxCfzkRcjpU3LgsOkyTp7GpqfQpuBy5C10ZlPkSXxmCOXIN3EJUOqMnGTIbHSuUxPkogg1sxOnafIsstBm/qQcISWo/XwS/fEkRUmW2/9nEvudZK3jF5L4byTZEEoskpPIsQ+1FoliUF4lTydLlTwdRVVSpJrdJ0muRDe/fAU7fxi1KmBZtgAAAABJRU5ErkJggg==) no-repeat center 7px;
            background-size: 12px 21.5px;
            z-index: 9999;
        }
        .map{
            width: 100%;
            height: 100%;
        }
        #btn-positioning {
            vertical-align: bottom;


            border: 0;
            box-shadow: 0 0 0;
            -webkit-box-shadow: 0 0 0;
            background-color: transparent;
            z-index: 3;
        }
        .icon-positioning-3 {
            background: url(//3gimg.qq.com/lightmap/mobilemap/common/images/map_position_small_normal_948d1bc.png) no-repeat center center;
            display: block;
            background-size: 54px 54px;
            height: 48px;
            padding-bottom: 0px;
        }
        .icon-positioning-3-cover {
            display: inline-block;
            height: 43px;
            width: 43px;
            margin-left: 14px;
            margin-top: 3px;
            border-radius: 21px;
            -webkit-border-radius: 21px;
        }
        .icon-positioning-3-cover:active {
            background: rgba(0,0,0,.1);
        }
        .zoomcontrol{
            bottom: 100px;
        }
        #common-widget-map .ctrl-layer .to-bottom .bottom-ctrl .to-left {
            position: fixed;
            bottom: 129px;
            left: -10px;
        }
        @font-face{font-family:icon;src:url(//3gimg.qq.com/lightmap/mobilemap/common/fonts/icon_f8c63a1.woff) format('woff'),url(//3gimg.qq.com/lightmap/mobilemap/common/fonts/icon_27c582a.ttf) format('truetype');font-weight:400;font-style:normal}
        .to-left {
            position: fixed;
            bottom: 8px;
            left: 16px;
            z-index: 3;
        }
        #btn-index-menu {
            display: none;
            transform: scale(0.6);
            -webkit-transform: scale(0.6);
        }
        .cbutton {
            border-radius: 72px;
            background-color: rgba(255,255,255,.95);
            -webkit-box-shadow: 0 0 6px rgba(0,0,0,.1);
            box-shadow: 0 0 6px rgba(0,0,0,.1);
            border: 1px #bababa solid;
            overflow: hidden;
        }
        .cbutton i {
            display: block;
        }
        .cbutton i:before {
            display: block;
            font-size: 48px;
            width: 48px;
            line-height: 48px;
            text-align: center;
            color: #5e5e5e;
            padding: 10px;
        }
        .icon-more:before {
            content: "\e635";
        }
        .cbutton i:active {
            background: rgba(0,0,0,.1);
        }
        [class^=icon-], [class*=" icon-"] {
            font-family: icon;
            speak: none;
            font-style: normal;
            font-weight: 400;
            font-variant: normal;
            text-transform: none;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
    </style>
    <script>
        var _hmt = _hmt || [];
        (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?26e22164323c5647b2850122e1bd3ef4";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
        })();
    </script>
    
    <script src="//libs.baidu.com/jquery/2.1.1/jquery.min.js"></script>
    <script src="//cdn.staticfile.org/history.js/1.8/bundled-uncompressed/html5/jquery.history.js"></script>
    <!--引入Javascript API GL，参数说明参见下文-->
    <script src="//map.qq.com/api/gljs?v=1.exp&key=AIZBZ-F5M62-ACTUF-C2LQH-DQKC7-TVB7A"></script>
    <script src="//3gimg.qq.com/lightmap/components/geolocation/geolocation.min.js"></script>
    
    <link rel="stylesheet" href="//res.wx.qq.com/open/libs/weui/2.0.1/weui.min.css">
    <script type="text/javascript" src="//res.wx.qq.com/open/libs/weuijs/1.2.1/weui.min.js"></script>
    <script>
        function getUrlParam(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            var r = decodeURI(window.location.search.substr(1)).match(reg);
            if (r != null) return unescape(r[2]); return null;
        }

        function getLocation(){
            geolocation.getLocation(function(res){
                console.log(res)
                let center = new TMap.LatLng(res.lat, res.lng)
                map.easeTo({zoom:10,center:center},{duration: 1000})
            })
        }
        function restzoom(){
            console.log("restzoom")
            let orginCenter = new TMap.LatLng(chinaLatlng.lat,chinaLatlng.lng)
            map.easeTo({center:orginCenter,zoom:3,rotation:0,pitch:0})
        }
        var geolocation = new qq.maps.Geolocation("AIZBZ-F5M62-ACTUF-C2LQH-DQKC7-TVB7A", "myapp");
        var thisOrgName = decodeURI(getUrlParam("orgName"))
        var pagetitle = document.title
        var center
        var globleLatLng = {lat:26.102159897107754, lng:11.790522176484501}
        var chinaLatlng = {lat:35.71567199798269, lng:107.76217916748408}
        var map,control,loading,originLat,markerLayer,label
        var infoWindow = {}
        var orgList = []
        var orginZoom = 3;
        var thisOrgInfo = {}
        var orgdivZoom

        function openOrgPage(first=false){
            let orgName = thisOrgInfo.orgName
            if(getUrlParam('orgName')&& !first){
                console.log("替换链接")
                History.replaceState(null,`${orgName} - 汉服百科`,`/map/?orgName=${orgName}`)
            }else {
                console.log("添加链接")
                History.pushState(null,`${orgName} - 汉服百科`,`/map/?orgName=${orgName}`)  
            }
        }
        (function(window,undefined){

            // Bind to StateChange Event
            History.Adapter.bind(window,'statechange',function(){ // Note: We are using statechange instead of popstate
                var State = History.getState(); // Note: We are using History.getState() instead of event.state
                //console.log(State)
                if(State.url == `${window.location.origin}/map/`){
                    $('#common_content_box').html()
                    $('#common_content_box').hide()
                    $("#searchPart").show()
                    $("#map").show()
                    if(infoWindow.close){
                        infoWindow.close()
                    }
                    
                }else if(getUrlParam('orgName')){
                    setInfoWindow(thisOrgInfo.orgName,thisOrgInfo.orgid,thisOrgInfo.latLng)
                }
            });
            History.pushState(null,`${pagetitle}`,'/map/')
        })(window);
        function back(){
            console.log('back')
            History.replaceState(null,`${pagetitle}`,'/map/')
            map.setPitch(0)
            map.setRotation(0)
            
        }
        var orgPageHtml = `<div class="orgpage" id="orgpage">
            <!-- SWIPER -->
            <div class="slide" id="slide">
                <div class="back" onclick="back()"></div>
                <div id="outer" class="outer">
                    <ul id="inner" class="inner">
                    </ul>

        　　　　　　　<!--底部小圆点-->
                    <ol class="dot" id="dot">
                        <li class="active"></li>
                    </ol>
                </div>
    　　　　    <!--左右两侧的点击切换按钮-->
                <div class="arrow-box">
                    <div class="arrow arrow-l" id="arrow_l">‹</div>
                    <div class="arrow arrow-r" id="arrow_r">›</div>
                </div>
            </div>

            <!-- HEADER -->
            <div class="head-wrapper logo-mode">
                <a href="" id="logoHref" target="_blank">
                    <img class="logo" id="logoImage" src=""></img>
                </a>
                <div class="title">
                <div class="name" id="orgName"></div>
                <div style="display: flex;">
                    <a href="javascript:">
                        <img class="navigate" id="navigate" src="/res/navigate.png"></img>
                    </a>
                </div>
                </div>
            </div>

            <!-- MORE -->
            <div class="more">
                <div class="item" id="orgType" bindtap="navigateTo">
                <i class="iconfont iconleixing"></i>
                <pp>
                    组织类型：
                </pp>
                </div>
                <div class="item" id="locationAddress" bindtap="navigateTo">
                <i class="iconfont icondizhi"></i>
                <pp>
                组织地址：
                </pp>
                </div>
                <div class="item" id="telNumble" style="display: none;">
                <i class="iconfont icondianhua"></i>
                <pp>
                    联系电话：
                </pp>
                </div>
                <div class="item" id="QQGroup" bindtap="navigateTo">
                <i class="iconfont iconqq"></i>
                <pp>
                QQ 群号：
                </pp>
                </div>

                <div class="item" id="wxmp" bindtap="navigateTo">
                <i class="iconfont iconweixin"></i>
                <pp>
                    微信公众号：
                </pp>
                </div>
            </div>

            <!-- DESC -->
            <div class="desc" style="margin-bottom: 0px;">
                <div class="title">简介</div>
                <!-- TODO: rich-text -->
                <div class="content" id="orgDesc">
                </div>

            </div>


            </div>`

        function isMobile() {
            var userAgentInfo = navigator.userAgent;
 
            var mobileAgents = [ "Android", "iPhone", "SymbianOS", "Windows Phone", "iPad","iPod"];
 
            var mobile_flag = false;
 
            //根据userAgent判断是否是手机
            for (var v = 0; v < mobileAgents.length; v++) {
                if (userAgentInfo.indexOf(mobileAgents[v]) > 0) {
                    mobile_flag = true;
                    break;
                }
            }
             var screen_width = window.screen.width;
             var screen_height = window.screen.height;   
 
             //根据屏幕分辨率判断是否是手机
             if(screen_width < 500 && screen_height < 800){
                 mobile_flag = true;
             }
 
             return mobile_flag;
        }

        var mobile_flag = isMobile();
        if(!mobile_flag){
            //如果是PC，则对页面进行缩放，以适应windows系统的DPI缩放。
            orgdivZoom = window.screen.width / 1920
        }
        var MarkerStyle = {
            //创建一个styleId为"markerStyle"的样式（styles的子属性名即为styleId）
            "markerStyle": new TMap.MarkerStyle({
                "width": 20,  // 点标记样式宽度（像素）
                "height": 30, // 点标记样式高度（像素）
                //"src": '/res/marker.png',  //图片路径
                //焦点在图片中的像素位置，一般大头针类似形式的图片以针尖位置做为焦点，圆形点以圆心位置为焦点
                "anchor": { x: 16, y: 32 }
            })
        }


        function setSwiper(){
            var interval = 3000;                //轮播间隔时间
            var arrowL = $('#arrow_l');         //左侧箭头
            var arrowR = $('#arrow_r');         //右侧箭头

            var slideBox = $('#slide');         //轮播图区域
            var innerBox = $('#inner');         //内层大盒子
            var img = innerBox.children('li');  //每个图片
            var dot = $('#dot');                //小圆点盒子
            var imgW = slideBox.outerWidth()
            //var imgW = $(img[0]).outerWidth();  //每个li标签的宽度
            var imgCount = img.length;                   //总图片个数（不同图片的个数）（实际dom上是有7张）
            for(let i = 1; i < imgCount; i++){
                dot.append("<li></li>")
            }

            $('#inner li a').css("width",imgW)
            $('#inner').css("width",imgW*imgCount)
            $('#orgdiv').css("width",imgW)

            var i = 0;                          //初始化为第0张图片
            timer = null;                       //定时器
            if(imgCount < 2){
                return
            }
            //自动轮播
            timer = setInterval(function () {
                i++;
                innerBox.stop(false, true).animate({'left':-i*imgW+'px'},300)
                dot.find('li').removeClass('active').eq(i-1).addClass('active')
                
                if(i >= imgCount){
                    innerBox.animate({'left':0*imgW+'px'},0);
                    dot.find('li').removeClass('active').eq(0).addClass('active')
                    i = 0;
                }
            },interval)

            //点击右侧箭头，播放下一张
            arrowR.click(function () {
                i++;
                innerBox.stop(false, true).animate({'left':-i*imgW+'px'},300)
                dot.find('li').removeClass('active').eq(i-1).addClass('active')
                
                if(i >= imgCount){
                    innerBox.animate({'left':0*imgW+'px'},0);
                    dot.find('li').removeClass('active').eq(0).addClass('active')
                    i = 0;
                }
            })

            //点击左侧箭头，播放上一张
            arrowL.click(function () {
                i--;
                innerBox.stop(false, true).animate({'left':-i*imgW+'px'},300)
                dot.find('li').removeClass('active').eq(i-1).addClass('active')
                
                if(i < 1){
                    innerBox.animate({'left':(-imgCount+1)*imgW+'px'},0);
                    dot.find('li').removeClass('active').eq(imgCount-1).addClass('active')
                    i = imgCount;
                }
            })

            //鼠标经过轮播图区域时，清除定时器，停止自动轮播
            slideBox.mouseenter(function () {
                clearInterval(timer);
            })

            //鼠标离开轮播图区域时，重新启动自动轮播
            slideBox.mouseleave(function () {
                timer = setInterval(function () {
                    i++;
                    innerBox.stop(false, true).animate({'left':-i*imgW+'px'},300)
                    dot.find('li').removeClass('active').eq(i-1).addClass('active')
                    
                    if(i >= imgCount){
                        innerBox.animate({'left':0*imgW+'px'},0);
                        dot.find('li').removeClass('active').eq(0).addClass('active')
                        i = 0;
                    }
                },interval)
            })
        }

        function DraggableOn(){
            map.setDraggable(true)
        }

        function DraggableOff(){
            map.setDraggable(false)
        }

        function setInfoWindow(orgName,orgid,latLng) {

            
            //延迟打开的时间
            let duration = 2000
            let mapPoint = {}
            var orgpage
            let pageHeight = $(window).height()
            if(mobile_flag){
                $('#common_content_box').html(orgPageHtml)
                $('#common_content_box').show()
                $("#map").hide()
                $(".arrow-box").hide()
            }else{
                //设置infoWindow
                
                infoWindow.setPosition(latLng);//设置信息窗位置
                let orgNameLink = `<div id="orgdiv" style="width:400px;zoom:${orgdivZoom}">${orgPageHtml}</div>`
                infoWindow.setContent(orgNameLink);//设置信息窗内容
                $(".back").hide()
                orgpage = $('#orgpage')
                orgpage.mouseenter(function(){
                    map.setDraggable(false)
                })
                orgpage.mouseleave(function(){
                    map.setDraggable(true)
                })
                let mapStatus = {center:latLng,zoom:map.getZoom()}
                //map.panTo(latLng)
                if(thisOrgInfo.isSearch){
                    orginZoom = map.getZoom()
                    mapStatus.zoom = 12
                    map.setZoom(12)
                }else{
                }

                //map.panTo(latLng)
                mapPoint = map.projectToContainer(latLng)
                infoWindow.open(); //打开信息窗
                let finalCenter = {}
                //map.setCenter(latLng)
                finalCenter = map.unprojectFromContainer({x:mapPoint.x,y:mapPoint.y-pageHeight/2+80})
                mapStatus.center = finalCenter
                map.easeTo(mapStatus,{duration: duration})
                
                
            }

            

            
            //map.setDraggable(false)


            $('#orgName').text(`${orgName}`)
            let getUrl = "//cb.hanfu.wiki/orginfo"
            $.get(getUrl, { "id": orgid }, function (res) {
                console.log(res)
                let orgInfo = res.orgInfo
                let orgLogo = orgInfo.logoList[0]||'res/orgLogo.png'
                $('#orgName').text(`${orgInfo.orgName}`)
                $('#logoImage').attr("src", `${orgLogo}`)
                $("#logoHref").attr("href", `${orgLogo}`)
                let imgBanner = ""
                for (let x in orgInfo.orgImageList) {
                    let imgUrl = orgInfo.orgImageList[x]
                    imgBanner +=`<li><a href="${imgUrl}" target="_blank"><img src="${imgUrl}"></a></li>`
                }
                $('#inner').html(`${imgBanner}`)
                setSwiper()
                $('#orgType pp').text(`组织类型：${orgInfo.orgType}`)
                $('#locationAddress pp').text(`组织地址：${orgInfo.locationAddress}`)
                if(orgInfo.telNumble){
                    $('#telNumble pp').text(`联系电话：${orgInfo.telNumble}`)
                    $('#telNumble').show()
                }else{
                    $('#telNumble').hide()
                }
                
                $('#QQGroup pp').text(`QQ群号：${orgInfo.QQGroup}`)
                $('#wxmp pp').text(`微信公众号：${orgInfo.wxmp}`)
                $('#orgDesc').text(`${orgInfo.orgDesc}`)
                $('#navigate').click(function(){
                    window.open(`https://apis.map.qq.com/tools/poimarker?type=0&marker=coord:${latLng.lat},${latLng.lng};title:${orgInfo.orgName};addr:${orgInfo.locationAddress}&key=AIZBZ-F5M62-ACTUF-C2LQH-DQKC7-TVB7A&referer=hanfubaike`)
                })

            })
        }

        function markerClick(evt){
            let geometry = evt.geometry
            let orgName = geometry.properties.title.toString()
            let orgid =  geometry.properties.orgid
            let latLng = geometry.position
            thisOrgInfo = {
                orgName,
                orgid,
                latLng
            }
            openOrgPage()
            //setInfoWindow(orgName,orgid,latLng,false,true)
        }        

        function setMarkers(data) {
            loading.hide()

            orgList = data.orgList
            console.log(orgList)

            var markerList = []
            var positionList = []
            
            
            for (let x in orgList) {
                let lat = orgList[x].longLatiute.coordinates[1]
                let lng = orgList[x].longLatiute.coordinates[0]
                let name = orgList[x].orgName
                let id = orgList[x]._id
                if (name == thisOrgName){
                    thisOrgInfo.orgName = name
                    thisOrgInfo.latLng = new TMap.LatLng(lat, lng)
                    thisOrgInfo.orgid = id
                }
                positionList.push({
                    position: new TMap.LatLng(lat, lng)
                })
                let marker = {
                    "id": x,   //点标记唯一标识，后续如果有删除、修改位置等操作，都需要此id
                    "styleId": 'markerStyle',  //指定样式id
                    "position": new TMap.LatLng(lat, lng),  //点标记坐标位置
                    "properties": {//自定义属性
                        "title": name,
                        "orgid": id
                    }
                }
                markerList.push(marker)

            }

            markerLayer.on("click", markerClick)
            //markerLayer.add(markerList)


            //创建点聚合对象
            var markerCluster = new TMap.MarkerCluster({
                id: 'cluster', //图层id
                map: map,       //设置点聚合显示在哪个map对象中（创建map的段落省略）
                enableDefaultStyle: false,   //使用默认样式
                minimumClusterSize: 2,  //最小聚合点数：2个
                geometries: markerList, //....将您所有要打到图中的坐标点传入进来
                zoomOnClick: true,  //点击聚合数字放大展开
                gridSize: 60,       //聚合算法的可聚合距离，即距离小于该值的点会聚合至一起，默认为60，以像素为单位
                averageCenter: true, //每个聚和簇的中心是否应该是聚类中所有标记的平均值
                maxZoom: 16 //采用聚合策略的最大缩放级别，若地图缩放级别大于该值，则不进行聚合，标点将全部被展开
            });

            //初始化infoWindow
            infoWindow = new TMap.InfoWindow({
                map: map,
                position: new TMap.LatLng(39.984104, 116.307503),
                zIndex:2,
                offset: { x: 0, y: -48 } //设置信息窗相对position偏移像素，为了使其显示在Marker的上方
            });
            infoWindow.close();//初始关闭信息窗关闭
            infoWindow.on("closeclick",function(){
                if(thisOrgInfo.isSearch){
                    map.zoomTo(orginZoom)
                    thisOrgInfo.isSearch = false
                }
                History.replaceState(null,pagetitle,"/map/")
            })
            if(thisOrgInfo.orgName){
                console.log("搜索")
                thisOrgInfo.isSearch = true
                openOrgPage(true)
                //setInfoWindow(thisOrgInfo.orgName,thisOrgInfo.orgid,thisOrgInfo.latLng,true)
            }else{
                if(mobile_flag){
                    center = new TMap.LatLng(chinaLatlng.lat, chinaLatlng.lng)
                    orginZoom = 3
                    map.easeTo({center:center,zoom:orginZoom})
                }else{
                    center = new TMap.LatLng(globleLatLng.lat, globleLatLng.lng);
                    setTimeout(() => {
                        map.panTo(center,{duration:3000})
                    }, 300);
                    
                }
            }
            var clusterBubbleList = [];
            var markerGeometries = [];
            var labelGeometries = []
            var marker = null;

            // 监听聚合簇变化
            markerCluster.on('cluster_changed', function (e) {
                // 销毁旧聚合簇生成的覆盖物
                if (clusterBubbleList.length) {
                    clusterBubbleList.forEach(function (item) {
                        item.destroy();
                    })
                    clusterBubbleList = [];
                }
                markerGeometries = [];
                labelGeometries = []

                // 根据新的聚合簇数组生成新的覆盖物和点标记图层
                var clusters = markerCluster.getClusters();
                clusters.forEach(function (item) {
                    if (item.geometries.length > 1) {
                        let clusterBubble = new ClusterBubble({
                            map,
                            position: item.center,
                            content: item.geometries.length,
                        });
                        clusterBubble.on('click', () => {
                            map.fitBounds(item.bounds);
                        });
                        clusterBubbleList.push(clusterBubble);
                    } else {
                        markerGeometries.push(item.geometries[0]);
                        let position = item.geometries[0].position
                        let name = item.geometries[0].properties.title
                        let orgid = item.geometries[0].properties.orgid
                        labelGeometries.push({
                            'id': 'label', //点图形数据的标志信息
                            'styleId': 'label', //样式id
                            'position': position, //标注点位置
                            'content': name, //标注文本
                            'rank':999, //文本碰撞时的优先级，值越大优先级越高。
                            'properties': { //标注点的属性数据
                                'title': name,
                                'orgid':orgid
                                }
                        });
                    }
                })
                // 已创建过点标记图层，直接更新数据
                markerLayer.setGeometries(markerGeometries);
                label.setGeometries(labelGeometries)
            });


            //监听标注点击事件
            markerCluster.on("click", function (evt) {
                console.log(evt)
                let geometries = evt.cluster.geometries
                //设置infoWindow
                infoWindow.open(); //打开信息窗
                infoWindow.setPosition(geometries[0].position);//设置信息窗位置
                infoWindow.setContent(geometries[0].properties.title.toString());//设置信息窗内容
                for (let x in geometries) {

                }


            })

        }

        //地图初始化函数，本例取名为init，开发者可根据实际情况定义
        function initMap() {
            //定义地图中心点坐标
            //var center = new TMap.LatLng(24.833091602492335, 31.470296073417103)
            center = new TMap.LatLng(chinaLatlng.lat,chinaLatlng.lng);
            //定义map变量，调用 TMap.Map() 构造函数创建地图
            map = new TMap.Map(document.getElementById('container'), {
                center: center,//设置地图中心点坐标
                zoom: orginZoom,   //设置地图缩放级别
                viewMode:"2D",
                pitch: 0,  //设置俯仰角
                rotation: 0,    //设置地图旋转角度
                mapStyleId: "style3",
            });
            //map.on("mousedown",function(res){
                //console.log(res)
                //map.setDraggable(true)
            //})
           // map.on("touchstart",function(res){
                //console.log(res)
                //map.setDraggable(true)
            //})
            map.removeControl(TMap.constants.DEFAULT_CONTROL_ID.SCALE);
            $('.logo-text').append('<a href="http://www.beian.gov.cn/" target="_blank" class="link_black" style="color: #1c4f7b;"> 粤ICP备20022545号-1 </a>')
            control = map.getControl(TMap.constants.DEFAULT_CONTROL_ID.ZOOM);
            control.setPosition(TMap.constants.CONTROL_POSITION.BOTTOM_RIGHT);

            //创建并初始化MultiMarker
            markerLayer = new TMap.MultiMarker({
                map: map,  //指定地图容器
                //样式定义
                styles: MarkerStyle,
                //点标记数据数组
                geometries: [
                ]
            });
            //初始化label
            var fontSize = 16
            if(mobile_flag){
                fontSize = 14
            }
            label = new TMap.MultiLabel({
                id: 'label-layer',
                map: map,
                styles: {
                    'label': new TMap.LabelStyle({
                        'color': '#4F4F4F', //颜色属性
                        'size': fontSize, //文字大小属性
                        'offset': { x: 0, y: 7 }, //文字偏移属性单位为像素
                        'angle': 0, //文字旋转属性
                        'alignment': 'center', //文字水平对齐属性
                        'verticalAlignment': 'middle' //文字垂直对齐属性
                    })
                },
                geometries: []    
            })

            map.on("click",function(res){
                infoWindow.close()
                if(thisOrgInfo.isSearch){
                    map.zoomTo(orginZoom)
                    thisOrgInfo.isSearch = false
                }
                History.replaceState(null,pagetitle,"/map/")
            })
            let getUrl = "//cb.hanfu.wiki/orgList"
            loading = weui.loading('正在加载', {
                className: 'custom-classname'
            });
            $.get(getUrl, "", setMarkers).error(function(res){
                console.log(res)
                weui.alert(`获取数据失败：${res.responseText}`, { title:  '提示'});
                loading.hide()
            })

        }

        // 以下代码为基于DOMOverlay实现聚合点气泡
        function ClusterBubble(options) {
            TMap.DOMOverlay.call(this, options);
        }

        ClusterBubble.prototype = new TMap.DOMOverlay();

        ClusterBubble.prototype.onInit = function (options) {
            this.content = options.content;
            this.position = options.position;
        };

        // 销毁时需要删除监听器
        ClusterBubble.prototype.onDestroy = function () {
            this.dom.removeEventListener('click', this.onClick);
            this.removeAllListeners();
        };

        ClusterBubble.prototype.onClick = function () {
            this.emit('click');
        };

        // 创建气泡DOM元素
        ClusterBubble.prototype.createDOM = function () {
            var dom = document.createElement('div');
            dom.classList.add('clusterBubble');
            dom.innerText = this.content;
            dom.style.cssText = [
                'width: ' + (40 + parseInt(this.content) * 2) + 'px;',
                'height: ' + (40 + parseInt(this.content) * 2) + 'px;',
                'line-height: ' + (40 + parseInt(this.content) * 2) + 'px;',
            ].join(' ');

            // 监听点击事件，实现zoomOnClick
            this.onClick = this.onClick.bind(this);
            dom.addEventListener('click', this.onClick);
            return dom;
        };

        ClusterBubble.prototype.updateDOM = function () {
            if (!this.map) {
                return;
            }
            // 经纬度坐标转容器像素坐标
            let pixel = this.map.projectToContainer(this.position);

            // 使文本框中心点对齐经纬度坐标点
            let left = pixel.getX() - this.dom.clientWidth / 2 + 'px';
            let top = pixel.getY() - this.dom.clientHeight / 2 + 'px';
            this.dom.style.transform = `translate(${left}, ${top})`;

            this.emit('dom_updated');
        };

        window.ClusterBubble = ClusterBubble;

    </script>
</head>
<!-- 页面载入后，调用init函数 -->

<body onload="initMap()">
    <!-- 定义地图显示容器 -->
    <div class="map" id="map">
        <div class="page__bd" id="searchPart">
            <!--<a href="javascript:" class="weui-btn weui-btn_primary">点击展现searchBar</a>-->
            <div class="weui-search-bar" id="searchBar" style="background-color: #fff;">
                <form class="weui-search-bar__form">
                    <img class="logo" src="/res/logo.png" onclick="backHome()">
                    <div class="weui-search-bar__box">
                        <i class="weui-icon-search"></i>
                        <input type="search" class="weui-search-bar__input" id="searchInput" placeholder="请输入组织名或城市名" required/>
                        <a href="javascript:" class="weui-icon-clear" id="searchClear"></a>
                    </div>
                    <label class="weui-search-bar__label" id="searchText">
                        <i class="weui-icon-search"></i>
                        <span>搜索</span>
                    </label>
                </form>
                <a href="javascript:" class="weui-search-bar__cancel-btn" id="searchCancel">取消</a>
            </div>
            <div class="weui-cells searchbar-result" id="searchResult" style="display: none;padding: 10px;">

            </div>
        </div>

        <div id="container">

        </div>

        <div class="to-left">
            <div id="btn-positioning" onclick="getLocation()">
                <i class="icon-positioning icon-positioning-3 highlight">
                    <i class="icon-positioning-3-cover"></i>
                </i>
            </div>
            <!-- 弹出菜单-->
           <div class="cbutton" id="btn-index-menu" data-adtag="more" style="display: block;"><a target="_blank" href="https://mp.weixin.qq.com/s/KFIWjE8kWDNburB2paUBIA"><i class="icon-more"></i></a></div>

       </div>
    </div>
    <div class="common_content_box" id="common_content_box"></div>
    <script type="text/javascript">

        function clickTips(self){
            let searchResult = $('#searchResult')
            searchResult.hide();
            let isSearch = true
            let orgName = $(self).data('orgname')
            let orgid = $(self).data('orgid')
            let lat = $(self).data('lat')
            let lng = $(self).data('lng')
            let latLng = new TMap.LatLng(lat, lng)
            thisOrgInfo = {
                orgName,
                orgid,
                latLng,
                isSearch
            }
            openOrgPage()
            //setInfoWindow(orgName,orgid,latLng,isSearch)
            //map.zoomTo(8)
        }
        function backHome(){
            window.location = '/'
        }

        $(function(){
            var $searchBar = $('#searchBar'),
                $searchResult = $('#searchResult'),
                $searchText = $('#searchText'),
                $searchInput = $('#searchInput'),
                $searchClear = $('#searchClear'),
                $searchCancel = $('#searchCancel');
    
            function hideSearchResult(){
                $searchResult.hide();
                $searchInput.val('');
            }
            function cancelSearch(){
                hideSearchResult();
                $searchBar.removeClass('weui-search-bar_focusing');
                $searchText.show();
            }

            function clearInput(){
                $searchResult.hide();
                History.replaceState(null,pagetitle,"/map/")
                infoWindow.close()
                map.zoomTo(orginZoom)
            }
    
            $searchText.on('click', function(){
                $searchBar.addClass('weui-search-bar_focusing');
                $searchInput.focus();
            });
            $searchInput
                .on('blur', function () {
                    if(!this.value.length){
                        clearInput();
                        cancelSearch();
                    } 
                })
                .on('input', function(){
                    if(this.value.length) {
                        let searchTips = []
                        let value = this.value
                        let tempHtml = ""
                        let i = 0
                        for(let x in orgList){
                            if(i >10){
                                break
                            }
                            let orgName = orgList[x].orgName
                            let orgid = orgList[x]._id
                            let locationAddress = orgList[x].locationAddress
                            let lat = orgList[x].longLatiute.coordinates[1]
                            let lng = orgList[x].longLatiute.coordinates[0]
                            let nameIndex = orgName.indexOf(value)
                            let addressIndex = locationAddress.indexOf(value)
                            let orgTips1 = ""
                            let orgTips2 = ""
                            let addressTips1 = ""
                            let addressTips2 = ""
                            if(nameIndex > -1 || addressIndex > -1){
                                if(nameIndex > -1){
                                    orgTips1 = orgName.split(value)[0]
                                    orgTips2 = orgName.split(value)[1]
                                }else if(addressIndex > -1){
                                    addressTips1 = locationAddress.split(value)[0]
                                    addressTips2 = locationAddress.split(value)[1]
                                }
                                
                                i++
                                tempHtml += `<div class="weui-cell weui-cell_active weui-cell_access" style="padding:10px" onclick="clickTips(this)" data-orgid="${orgid}" data-orgName="${orgName}" data-lat="${lat}" data-lng="${lng}">
                                                    <div class="weui-cell__bd weui-cell_primary tips">
                                                        <p>${orgName}</p>
                                                        <p style="font-size:12px;left:4px;color: #999;">${locationAddress}</p>
                                                    </div>
                                                </div>`
                                
                            }
                        }
                        $searchResult.html(tempHtml)
                        if(tempHtml){
                            $searchResult.show();
                        }
                        
                    } else {
                        //$searchResult.children(".weui-cell_access").remove()
                        clearInput()
                    }
                })
            ;
            $searchClear.on('click', function(){
                hideSearchResult();
                $searchInput.focus();
            });
            $searchCancel.on('click', function(){
                cancelSearch();
                $searchInput.blur();
            });
            if(mobile_flag){
                $("#searchPart").css("width","auto")
                $("#searchPart").css("right","10px")
            }
        });
    </script>
</body>

</html>